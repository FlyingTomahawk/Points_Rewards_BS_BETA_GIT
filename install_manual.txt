####### POINTS AND REWARDS BS #########
  created by Ben Zukrel, Deep Silver Accessories

  Updated for osC Bootstrap version by raiwa, LeeFoster and Tsimi.
  
  osCommerce, Open Source E-Commerce Solutions
  http://www.oscommerce.com

  Copyright (c) 2017 osCommerce

  Released under the GNU General Public License

##################################################

******************* MAKE SURE TO BACKUP YOUR FILES BEFORE ***********************
This addon has been modified to work with the latest osC BS GOLD and EDGE.
If your osCommerce version is not osC BS GOLD or EDGE, don't even start.

Please use it at your own risk.
------------------------------------------------------------------------------------------

####### STEP BY STEP INSTALLATION ################

A. ADDING NEW FILES.
B. EDITING OSC FILES.(catalog directory).
C. EDITING OSC FILES.(admin directory). 
D. INSTALL MODULES
E. INSTALL OPTIONAL MODULES


A. ADDING NEW FILES.
copy the new files provided into the same location in your catalog and admin directory.

-- Add this to catalog section --------------

    catalog/my_points.php
    catalog/my_points_help.php
    catalog/includes/functions/redemptions.php
    catalog/includes/hooks/shop/points/points_hooks.php
    catalog/includes/languages/english/my_points.php
    catalog/includes/languages/english/my_points_help.php
    catalog/includes/languages/english/hooks/shop/points/points_hooks.php	
	catalog/includes/languages/english/modules/boxes/bm_information_points.php
	catalog/includes/languages/english/modules/boxes/bm_shopping_cart_points.php
	catalog/includes/languages/english/modules/content/product_info_points/cm_pi_points.php
	catalog/includes/languages/english/modules/content/reviews_points/cm_r_points.php
	catalog/includes/languages/english/modules/header_tags/ht_points_rewards.php
	catalog/includes/languages/english/modules/navbar_modules/nb_shopping_cart_points.php
	catalog/includes/languages/english/modules/order_total/ot_redemptions.php
	catalog/includes/languages/english/modules/pages/tp_account.php
	catalog/includes/languages/english/modules/payment/points.php	
    catalog/includes/modules/boxes/bm_information_points.php
    catalog/includes/modules/boxes/bm_shopping_cart_points.php
    catalog/includes/modules/boxes/templates/information_points.php
    catalog/includes/modules/boxes/templates/shopping_cart_points.php
	catalog/includes/modules/content/product_info_points/cm_pi_points.php
	catalog/includes/modules/content/product_info_points/templates/points.php
	catalog/includes/modules/content/reviews_points/cm_r_points.php
	catalog/includes/modules/content/reviews_points/templates/points.php
	catalog/includes/modules/header_tags/ht_points_rewards.php
	catalog/includes/modules/navbar_modules/nb_shopping_cart_points.php
	catalog/includes/modules/navbar_modules/templates/shopping_cart_points.php
	catalog/includes/modules/order_total/ot_redemptions.php
	catalog/includes/modules/payment/points.php
	
====DONE====
-- Add this to admin section --------------

    admin/customers_points.php
    admin/customers_points_credit.php (cron script)
    admin/customers_points_expire.php (cron script)
    admin/customers_points_pending.php
    admin/customers_points_referral.php
	admin/includes/boxes/points_rewards.php
    admin/includes/languages/english/customers_points.php
    admin/includes/languages/english/customers_points_pending.php
    admin/includes/languages/english/customers_points_referral.php
	admin/includes/languages/english/images/buttons/button_add_points.gif
	admin/includes/languages/english/images/buttons/button_adjust_points.gif
	admin/includes/languages/english/images/buttons/button_cancel_points.gif
	admin/includes/languages/english/images/buttons/button_confirm_points.gif
	admin/includes/languages/english/images/buttons/button_delete_points.gif
	admin/includes/languages/english/images/buttons/button_rollback_points.gif
	
====DONE====
	
******************************************************************************************

B. EDITING OSC FILES.(catalog directory).

CATALOG STEP = 1.   open catalog/includes/modules/pages/tp_account.php

**This step has 2 parts

FIND:

    function build() {
      global $oscTemplate;

REPLACE WITH:

    function build() {
      global $oscTemplate;
      global $customer_id, $currencies; // POINTS REWARDS BS
	  
FIND:

        $output .= '  </ul>' .
                   '</div>';
      }
	  
ADD AFTER IT:

// BOF POINTS REWARDS BS //-->
    if (MODULE_HEADER_TAGS_POINTS_REWARDS_USE_POINTS_SYSTEM == 'True') {
      
    require('includes/languages/' . $language . '/modules/pages/tp_account.php');
		
	$output .= '<h2>' . TP_ACCOUNT_MY_POINTS_TITLE . '</h2>
           <div class="contentText">  
			  <ul class="list-unstyled">';

  $has_points = tep_get_shopping_points($customer_id);
  if ($has_points > 0) {
	  $output .= '<h4><span class="label label-info">' . sprintf(TP_ACCOUNT_MY_POINTS_CURRENT_BALANCE, number_format($has_points, MODULE_HEADER_TAGS_POINTS_REWARDS_POINTS_POINTS_DECIMAL_PLACES), $currencies->format(tep_calc_shopping_pvalue($has_points))) . '</span></h4>';
  }
	$output .= '<li><i class="fa fa-plus"></i> <a href="' . tep_href_link('my_points.php', '', $request_type) . '">' . TP_ACCOUNT_MY_POINTS_VIEW . '</a></li>    
				<li><i class="fa fa-info-circle"></i> <a href="' . tep_href_link('my_points_help.php', '', $request_type) . '">' . TP_ACCOUNT_MY_POINTS_VIEW_HELP . '</a></li>
			  </ul>
           </div>'; 
  }
// EOF POINTS REWARDS BS //-->      


SAVE AND CLOSE!
------------------------------------------------------------------------------------------

CATALOG STEP = 2.   open catalog/checkout_confirmation.php
This will add hook register and call to checkout_confirmation page.

**This step has 2 parts

FIND:

  require('includes/application_top.php');

ADD AFTER IT:

// POINTS REWARDS BS
  $OSCOM_Hooks->register('points');

FIND:

  $payment_modules->update_status();

ADD AFTER IT:

// POINTS REWARDS BS
  echo $OSCOM_Hooks->call('points', 'PointsCheckoutConfirm');

SAVE AND CLOSE!
------------------------------------------------------------------------------------------

CATALOG STEP = 3.   open catalog/checkout_payment.php
This will add the javascript alart checking the box for invalid character. As well as 
allow points to be used as payment method.

**This step has 2 parts

FIND:

  require('includes/application_top.php');

ADD AFTER IT:

// POINTS REWARDS BS
  $OSCOM_Hooks->register('points');

FIND:

<?php
    $radio_buttons++;
  }
?>
      </tbody>
    </table>

  </div>
  
ADD AFTER IT:

<?php
// POINTS REWARDS BS
   echo $OSCOM_Hooks->call('points', 'PointsCheckoutPayment');
?>

SAVE AND CLOSE!
------------------------------------------------------------------------------------------

CATALOG STEP = 4.   open catalog/checkout_process.php
this will..
 1.Add pending points for a new success order with or without shipping cost.
 2.Balance customer shopping points account if points used.
 
 ** This step has 3 parts.

FIND:

  include('includes/application_top.php');
  
ADD AFTER IT:

// POINTS REWARDS BS
  $OSCOM_Hooks->register('points');

   
FIND:

    tep_db_perform(TABLE_ORDERS_TOTAL, $sql_data_array);
  }
  
ADD AFTER IT:

// POINTS REWARDS BS
  echo $OSCOM_Hooks->call('points', 'PointsCheckoutProcessAddPoints');

FIND:

  tep_session_unregister('comments');
  
ADD AFTER IT:

// POINTS REWARDS BS
  echo $OSCOM_Hooks->call('points', 'PointsCheckoutProcessUnregister');

SAVE AND CLOSE!
------------------------------------------------------------------------------------------

CATALOG STEP = 5.   open catalog/create_account.php
This will add Welcome Points (and send email) defined by admin if enabled.

**This step has 2 parts

FIND:

require('includes/application_top.php');
  
ADD AFTER IT:

// POINTS REWARDS BS
  $OSCOM_Hooks->register('points');
  
  
FIND:

$email_text .= EMAIL_WELCOME . EMAIL_TEXT . EMAIL_CONTACT . EMAIL_WARNING;

ADD AFTER IT:

// POINTS REWARDS BS
      echo $OSCOM_Hooks->call('points', 'PointsCreateAccountMailMod');

	  
SAVE AND CLOSE!  	  
------------------------------------------------------------------------------------------

CATALOG STEP = 6.   open catalog/create_account_success.php
This will add the text to notify the new signup users of the Welcome Points received,
with a link to the points page and points FAQ page.

**This step has 2 parts

FIND:

  require('includes/application_top.php');
  
ADD AFTER IT:

// POINTS REWARDS BS
  $OSCOM_Hooks->register('points');


FIND:

<div class="contentContainer">
  <div class="contentText">
    <?php echo TEXT_ACCOUNT_CREATED; ?>
	
ADD AFTER IT:
	  
	  <hr>
	  
<!-- POINTS REWARDS BS -->
	  <?php echo $OSCOM_Hooks->call('points', 'PointsCreateAccountSuccess');	?>               
               

SAVE AND CLOSE!
------------------------------------------------------------------------------------------
   
CATALOG STEP = 7.   open catalog/product_info.php
This will add the points credit information content module (if enabled).

FIND:

<?php
  if ($messageStack->size('product_action') > 0) {
    echo $messageStack->output('product_action');
  }
?>

ADD BEFORE IT:

<!-- BOF POINTS REWARDS BS -->
<div class="row">
  <?php echo $oscTemplate->getContent('product_info_points'); ?>
</div>
<!-- EOF POINTS REWARDS BS -->

OR place it anywhere you wish the information to be shown


SAVE AND CLOSE!
------------------------------------------------------------------------------------------

CATALOG STEP = 8.   open catalog/product_reviews.php
this will notify customers of points given for review and add link to points system help file

FIND:

<div class="page-header">
  <div class="row">
    <h1 class="col-sm-4" itemprop="name"><?php echo $products_name; ?></h1>
    <h2 class="col-sm-8 text-right-not-xs"><?php echo $products_price; ?></h2>
  </div>
</div>

ADD AFTER IT:

<!-- // BOF POINTS REWARDS BS //-->
<?php
   if ((MODULE_HEADER_TAGS_POINTS_REWARDS_USE_POINTS_SYSTEM == 'True') && (tep_not_null(MODULE_HEADER_TAGS_POINTS_REWARDS_POINTS_USE_POINTS_FOR_REVIEWS))) {
?>
	<div>
		<?php echo sprintf(REVIEW_HELP_LINK, $currencies->format(tep_calc_shopping_pvalue(MODULE_HEADER_TAGS_POINTS_REWARDS_POINTS_USE_POINTS_FOR_REVIEWS)), '<a href="' . tep_href_link('my_points_help.php','faq_item=13', 'NONSSL') . '" title="' . BOX_INFORMATION_MY_POINTS_HELP . '">' . BOX_INFORMATION_MY_POINTS_HELP . '</a>'); ?>
	</div>
<?php
  }
?>
<!-- // EOF POINTS REWARDS BS //-->

SAVE AND CLOSE!
------------------------------------------------------------------------------------------

CATALOG STEP = 9.   open catalog/product_reviews_write.php
this will add the points and notify customers of points given for review and add link to points system help file


FIND:

<div class="page-header">  
  <div class="row">
    <h1 class="col-sm-4"><?php echo $products_name; ?></h1>
    <h2 class="col-sm-8 text-right-not-xs"><?php echo $products_price; ?></h2>
  </div>
</div>

ADD AFTER IT:

<!-- // BOF POINTS REWARDS BS //-->
<?php
  if ((MODULE_HEADER_TAGS_POINTS_REWARDS_USE_POINTS_SYSTEM == 'True') && (tep_not_null(MODULE_HEADER_TAGS_POINTS_REWARDS_POINTS_USE_POINTS_FOR_REVIEWS))) {
?>
	<div>
		<?php echo sprintf(REVIEW_HELP_LINK, $currencies->format(tep_calc_shopping_pvalue(MODULE_HEADER_TAGS_POINTS_REWARDS_POINTS_USE_POINTS_FOR_REVIEWS)), '<a href="' . tep_href_link('my_points_help.php','faq_item=13', 'NONSSL') . '" title="' . BOX_INFORMATION_MY_POINTS_HELP . '">' . BOX_INFORMATION_MY_POINTS_HELP . '</a>'); ?>
	</div>
<?php
  }
?>
<!-- // EOF POINTS REWARDS BS //-->


SAVE AND CLOSE!
------------------------------------------------------------------------------------------

CATALOG STEP = 10.   open catalog/reviews.php
this will notify customers of points given for review and add link to points system help file

FIND:

<div class="page-header">
  <h1><?php echo HEADING_TITLE; ?></h1>
</div>

<div class="contentContainer">

ADD AFTER IT:

<!-- BOF POINTS REWARDS BS //-->
<div class="row">
  <?php echo $oscTemplate->getContent('reviews_points'); ?>
</div>
<!-- EOF POINTS REWARDS BS //-->


SAVE AND CLOSE!
------------------------------------------------------------------------------------------

CATALOG STEP = 11.   open catalog/includes/application_top.php

FIND:

(GOLD)
// infobox
  require(DIR_WS_CLASSES . 'split_page_results.php');
(EDGE)
// split-page-results
  require('includes/classes/split_page_results.php');
  
ADD AFTER IT:

// POINTS REWARDS BS
  require('includes/functions/redemptions.php');

  
SAVE AND CLOSE!
------------------------------------------------------------------------------------------

CATALOG STEP = 12.   open catalog/includes/modules/payment/paypal_standard.php
(This is an optional step and only needed if you use the PayPal Standard payment method.)

** this step has 2 parts.

FIND (around line 240):
(GOLD)
            tep_db_perform(TABLE_ORDERS_TOTAL, $sql_data_array);
          }
		  
(EDGE)
            tep_db_perform('orders_total', $sql_data_array);
          }

ADD AFTER IT:

// BOF POINTS REWARDS BS //-->
  if ((MODULE_HEADER_TAGS_POINTS_REWARDS_USE_POINTS_SYSTEM == 'True') && (MODULE_HEADER_TAGS_POINTS_REWARDS_USE_REDEEM_SYSTEM == 'True')) {
// customer pending points added
      if ($order->info['total'] > 0) {
          $points_toadd = get_points_toadd($order);
          $points_comment = 'TEXT_DEFAULT_COMMENT';
          $points_type = 'SP';
          if ((get_redemption_awards($customer_shopping_points_spending) == true) && ($points_toadd >0)) {
              tep_add_pending_points($customer_id, $insert_id, $points_toadd, $points_comment, $points_type);
          }
      }
// customer referral points added
      if ((tep_session_is_registered('customer_referral')) && (tep_not_null(MODULE_HEADER_TAGS_POINTS_REWARDS_POINTS_USE_REFERRAL_SYSTEM))) {
          $referral_twice_query = tep_db_query("select unique_id from customers_points_pending where orders_id = '". (int)$insert_id ."' and points_type = 'RF' limit 1");
          if (!tep_db_num_rows($referral_twice_query)) {
              $points_toadd = MODULE_HEADER_TAGS_POINTS_REWARDS_POINTS_USE_REFERRAL_SYSTEM;
              $points_comment = 'TEXT_DEFAULT_REFERRAL';
              $points_type = 'RF';
              tep_add_pending_points($customer_referral, $insert_id, $points_toadd, $points_comment, $points_type);
          }
      }
// customer shoppping points account balanced
      if ($customer_shopping_points_spending) {
          tep_redeemed_points($customer_id, $insert_id, $customer_shopping_points_spending);
      }
  }
// EOF POINTS REWARDS BS //-->


FIND:

	tep_session_unregister('comments');

ADD AFTER IT:

// BOF POINTS REWARDS BS
      tep_session_unregister('customer_shopping_points');
      tep_session_unregister('customer_shopping_points_spending');
      tep_session_unregister('customer_referral');
// EOF POINTS REWARDS BS	

SAVE AND CLOSE!
------------------------------------------------------------------------------------------

***********************************************************************************************

CONGRATULATIONS ! YOU ARE HALF WAY DONE! NOW LET'S DO THE ADMIN SECTION AND FINISH THE JOB!

***********************************************************************************************

C. EDITING OSC FILES.(admin directory).

ADMIN STEP = 1.   open admin/orders.php
This will add a quick pending points conformation check box.
To be used when confirming order or updating order status.
This option will only show up when there are pending points for that order
and only if Auto Credit Pending Points is set to "false".

**note that this step has 2 parts**

FIND:

            $customer_notified = '1';
          }
		  
ADD AFTER IT:

// BOF POINTS REWARDS BS //-->
          if ((MODULE_HEADER_TAGS_POINTS_REWARDS_USE_POINTS_SYSTEM == 'True') && !tep_not_null(MODULE_HEADER_TAGS_POINTS_REWARDS_POINTS_POINTS_AUTO_ON)) {
                  if ((isset($_POST['confirm_points']) && ($_POST['confirm_points'] == 'on'))||(isset($_POST['delete_points']) && ($_POST['delete_points'] == 'on'))) {
                          $comments = ENTRY_CONFIRMED_POINTS  . $comments;
                          $customer_query = tep_db_query("select customer_id, points_pending from customers_points_pending where points_status = 1 and points_type = 'SP' and orders_id = '" . (int)$oID . "' limit 1");
                          $customer_points = tep_db_fetch_array($customer_query);
                          if (tep_db_num_rows($customer_query)) {
                                  if (tep_not_null(MODULE_HEADER_TAGS_POINTS_REWARDS_POINTS_POINTS_AUTO_EXPIRES)) {
                                          $expire  = date('Y-m-d', strtotime('+ '. MODULE_HEADER_TAGS_POINTS_REWARDS_POINTS_POINTS_AUTO_EXPIRES .' month'));
                                          tep_db_query("update customers set customers_shopping_points = customers_shopping_points + '". $customer_points['points_pending'] ."', customers_points_expires = '". $expire ."' where customers_id = '". (int)$customer_points['customer_id'] ."'");
                                  } else {
                                          tep_db_query("update customers set customers_shopping_points = customers_shopping_points + '". $customer_points['points_pending'] ."' where customers_id = '". (int)$customer_points['customer_id'] ."'");
                                  }

                                  if (isset($_POST['delete_points']) && ($_POST['delete_points'] == 'on')) {
                                          tep_db_query("delete from customers_points_pending where orders_id = '" . (int)$oID . "' and points_type = 'SP' limit 1");
                                          $sql = "optimize table customers_points_pending";
                                  }

                                  if (isset($_POST['confirm_points']) && ($_POST['confirm_points'] == 'on')) {
                                          tep_db_query("update customers_points_pending set points_status = 2 where orders_id = '" . (int)$oID . "' and points_type = 'SP' limit 1");
                                          $sql = "optimize table customers_points_pending";
                                  }
                          }
                  }
          }
// EOF POINTS REWARDS BS //-->

FIND:

      <tr>
        <td colspan="2" align="right"><?php echo tep_draw_button(IMAGE_UPDATE, 'disk', null, 'primary'); ?></td>
      </tr>	
	  
ADD AFTER IT:
			
<!-- BOF POINTS REWARDS BS //-->
<?php
    if ((MODULE_HEADER_TAGS_POINTS_REWARDS_USE_POINTS_SYSTEM == 'True') && !tep_not_null(MODULE_HEADER_TAGS_POINTS_REWARDS_POINTS_POINTS_AUTO_ON)) {
        $p_status_query = tep_db_query("select points_status from customers_points_pending where points_status = 1 and points_type = 'SP' and orders_id = '" . (int)$oID . "' limit 1");
            if (tep_db_num_rows($p_status_query)) {
                    echo '<tr><td colspan="2" align="right"><strong>' . ENTRY_NOTIFY_POINTS . '</strong>&nbsp;' . ENTRY_QUE_POINTS . tep_draw_checkbox_field('confirm_points', '', false) . '&nbsp;' . ENTRY_QUE_DEL_POINTS . tep_draw_checkbox_field('delete_points', '', false) . '</td></tr>';
            }
    }
?>
<!-- EOF POINTS REWARDS BS //-->

SAVE AND CLOSE!
------------------------------------------------------------------------------------------
                                         
ADMIN STEP = 2.   open admin/includes/functions/general.php
This is to make sure that pending points for any order you delete will also deleted,
(please note that this will delete points in a pending status only, if you delete and order that
its points already approved you will have to delete those points manually)

FIND:

    tep_db_query("delete from " . TABLE_ORDERS_TOTAL . " where orders_id = '" . (int)$order_id . "'");

ADD AFTER IT:

// BOF POINTS REWARDS BS
    tep_db_query("delete from customers_points_pending where orders_id = '" . (int)$order_id . "'");
    $sql = "optimize table customers_points_pending";
// EOF POINTS REWARDS BS

SAVE AND CLOSE!
------------------------------------------------------------------------------------------
                                         
ADMIN STEP = 3.   open admin/includes/languages/english.php

ADD THIS AT THE END OF YOUR FILE

// BOF POINTS REWARDS BS
define('BOX_CUSTOMERS_POINTS', 'Customers Points');
define('BOX_CUSTOMERS_POINTS_PENDING', 'Pending Points');
define('BOX_CUSTOMERS_POINTS_REFERRAL', 'Referral Points');
define('ENTRY_NOTIFY_POINTS', 'Confirm Pending Points:');
define('ENTRY_QUE_POINTS', 'and Que');
define('ENTRY_QUE_DEL_POINTS', 'and Delete:');
define('ENTRY_CONFIRMED_POINTS', 'Points Confirmed.  ');
// EOF POINTS REWARDS BS

SAVE AND CLOSE!
------------------------------------------------------------------------------------------
##################  END OF STEP BY STEP INSTALLATION      ################################
------------------------------------------------------------------------------------------
******************************************************************************************

D. INSTALL MODULE

1.)
Access your admin area and install the "Points Redemptions" order total module. (Modules -> Order Total)
This option must appear after "Sub-Total" and before "Total". 
When you first install "Points Redemptions" the sort order no is set at a default of 4, which is the same as "Total" .
YOU MUST change your value for "Total" sort order to any number higher then 4 (e.g. 5).

2.)
Access your admin area, install and setup the "Points and Rewards" header tags module. (Modules -> Header Tags)

3.)
Access your admin area and install the "Points" payment method module. (Modules -> Payment)

E. INSTALL OPTIONAL MODULES

1.)
Access your admin area and install the "Shopping Cart with points" navbar module. (Modules -> Navbar Modules)
This will show the current Points Status inside the dropdown shopping cart.

2.)
Access your admin area and install the "Product Points" products_info_points content module. (Modules -> Content)
This will add the points credit information on the product info page.

3.)
Access your admin area and install the "Shopping Cart with Points" box module. (Modules -> Boxes)
This will display points info inside the shopping cart box.(customers must login).
This will only show up when a customer points is bigger then 0

4.)
Access your admin area and install the "Information Points" box module. (Modules -> Boxes)
This will add an information box with a link to My Points FAQ

***************************************************************
THAT'S IT!
***************************************************************